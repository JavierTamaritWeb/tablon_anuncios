<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario de Eventos - Falla Suïssa</title>
  <!-- Flatpickr CSS (para el Date Range Picker) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* =============================
       BLOQUE: calendario-eventos
    ============================= */
    .calendario-eventos {
      max-width: 900px;
      margin: 2rem auto;
      padding: 2rem;
      background-color: #fdf2e9; /* naranja-suave */
      border: 1px solid #fdfdfd;  /* blanco-sutil-gris */
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      font-family: Arial, sans-serif;
      position: relative;
    }
    .calendario-eventos__cabecera {
      text-align: center;
      margin-bottom: 1.5rem;
      position: relative;
    }
    .calendario-eventos__cabecera-titulo {
      font-size: 2.5rem;
      color: #ff6f61;
      margin: 0;
    }
    /* =============================
       ACCIONES: Botones superiores agrupados
    ============================= */
    .calendario-eventos__acciones {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
    }
    .calendario-eventos__boton-quitar,
    .calendario-eventos__modo-boton {
      background-color: #fff;
      color: #333;
      border: 1px solid #333;
      border-radius: 5px;
      padding: 0.5rem 1rem;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    .calendario-eventos__boton-quitar:hover,
    .calendario-eventos__modo-boton:hover {
      background-color: #444;
      color: #fff;
    }
    /* =============================
       CONTROLES DE FILTRO
    ============================= */
    .calendario-eventos__controles {
      margin-bottom: 1.5rem;
    }
    .calendario-eventos__fila {
      display: grid;
      gap: 5rem;
      margin-bottom: 1rem;
    }
    @media (max-width: 480px) {
      .calendario-eventos__fila {
        grid-template-columns: 1fr;
      }
    }
    @media (min-width: 481px) and (max-width: 768px) {
      .calendario-eventos__fila {
        grid-template-columns: repeat(2, minmax(150px, 1fr));
      }
    }
    @media (min-width: 769px) and (max-width: 1023px) {
      .calendario-eventos__fila {
        grid-template-columns: repeat(3, minmax(150px, 1fr));
      }
    }
    @media (min-width: 1024px) {
      .calendario-eventos__fila {
        grid-template-columns: repeat(4, minmax(150px, 1fr));
        gap: 2rem;
      }
    }
    .calendario-eventos__control {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
      color: #333;
      position: relative;
      padding: 0 2rem;
    }
    .calendario-eventos__control label {
      margin-bottom: 0.3rem;
    }
    .calendario-eventos__control-texto,
    .calendario-eventos__control-fecha,
    .calendario-eventos__control-busqueda {
      width: 100%;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      border: 1px solid #333;
      border-radius: 5px;
      background-color: #fff;
      color: #333;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    @media (min-width: 1024px) {
      .calendario-eventos__control-texto,
      .calendario-eventos__control-fecha,
      .calendario-eventos__control-busqueda {
        padding: 0.5rem 0.75rem;
        font-size: 0.95rem;
      }
    }
    /* Hover en controles */
    .calendario-eventos__control:hover {
      color: #fff;
    }
    .calendario-eventos__control:hover label {
      color: #333;
    }
    .calendario-eventos__control:hover .calendario-eventos__control-texto,
    .calendario-eventos__control:hover .calendario-eventos__control-fecha,
    .calendario-eventos__control:hover .calendario-eventos__control-busqueda {
      background-color: #ff6f61;
      color: #fff;
    }
    .calendario-eventos__control:hover .calendario-eventos__control-texto::placeholder,
    .calendario-eventos__control:hover .calendario-eventos__control-fecha::placeholder,
    .calendario-eventos__control:hover .calendario-eventos__control-busqueda::placeholder {
      color: #fff;
    }
    .calendario-eventos__control:hover .calendario-eventos__borrar-campo,
    .calendario-eventos__control:hover .calendario-eventos__control-fecha-borrar {
      color: #fff;
    }
    .calendario-eventos__borrar-campo {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: #333;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .calendario-eventos__borrar-campo:hover {
      color: red;
    }
    .calendario-eventos__campo-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    /* Rango de Fechas (Flatpickr) */
    .calendario-eventos__control-fecha-wrapper {
      position: relative;
      display: flex;
      flex-direction: row;
      width: 14rem;
    }
    .calendario-eventos__control-fecha {
      width: 100%;
      padding-right: 4rem;
    }
    .calendario-eventos__control-fecha::-webkit-calendar-picker-indicator {
      position: absolute;
      right: 2.5rem;
      cursor: pointer;
      transition: filter 0.3s ease;
    }
    .calendario-eventos__control-fecha-wrapper:hover .calendario-eventos__control-fecha::-webkit-calendar-picker-indicator {
      filter: invert(100%);
    }
    .calendario-eventos__control-fecha-borrar {
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      background: transparent;
      border: none;
      font-size: 1.2rem;
      color: #333;
      cursor: pointer;
      transition: color 0.3s ease;
    }
    .calendario-eventos__control-fecha-wrapper:hover .calendario-eventos__control-fecha-borrar {
      color: #fff;
    }
    /* =============================
       LEYENDA Y DESCRIPCIÓN DEL MES
    ============================= */
    .calendario-eventos__leyenda {
      margin: 1rem 0;
      font-size: 1.2rem;
      color: #333;
      text-align: center;
      font-weight: bold;
    }
    .calendario-eventos__detalles-mes {
      margin: 1rem 0;
      background-color: #fff;
      border: 1px solid #fdfdfd;
      border-radius: 5px;
      padding: 1rem;
      color: #333;
    }
    .calendario-eventos__detalles-mes h2 {
      margin-top: 0;
      font-size: 1.3rem;
      color: #ff6f61;
    }
    .calendario-eventos__detalles-mes ul {
      margin-left: 1.5rem;
      list-style: disc;
    }
    .calendario-eventos__detalles-mes li {
      margin-bottom: 0.5rem;
    }
    /* =============================
       MINI CALENDARIO
    ============================= */
    .calendario-eventos__mini {
      margin: 1rem 0;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 0.5rem;
      text-align: center;
      position: relative;
      transition: opacity 0.5s ease;
    }
    .calendario-eventos__mini-encabezado {
      font-weight: bold;
      color: #333;
    }
    .calendario-eventos__mini-dia {
      position: relative;
      padding: 0.5rem;
      border-radius: 4px;
      background-color: #fff;
      border: 1px solid #fdfdfd;
      transition: background-color 0.3s ease, color 0.3s ease;
      cursor: pointer;
    }
    .calendario-eventos__mini-dia:hover {
      background-color: #00909E;
      color: #fff;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .calendario-eventos__mini-dia.seleccionado {
      animation: pulse 0.5s ease-in-out;
    }
    .badge {
      position: absolute;
      top: 2px;
      right: 2px;
      background-color: red;
      color: #fff;
      border-radius: 50%;
      padding: 2px 5px;
      font-size: 0.7rem;
    }
    .calendario-eventos__mini-dia.mini-festivo {
      background-color: #FF6F61;
      color: #fff;
    }
    .calendario-eventos__mini-dia.mini-falla {
      background-color: #00909E;
      color: #fff;
    }
    .calendario-eventos__mini-dia.mini-evento {
      background-color: #4A4A4A;
      color: #fff;
    }
    .calendario-eventos__mini-dia.mini-urgente {
      background-color: #C13584;
      color: #fff;
    }
    .calendario-eventos__mini-dia.mini-informacion {
      background-color: #FFD700;
      color: #000;
    }
    .calendario-eventos__mini-dia.mini-recordatorio {
      background-color: #000080;
      color: #fff;
    }
    .calendario-eventos__mini-dia.fin-sabado {
      background-color: #e0e0e0;
    }
    .calendario-eventos__mini-dia.fin-domingo {
      background-color: #ffcccc;
      color: red;
    }
    .calendario-eventos__tooltip {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      bottom: 105%;
      left: 50%;
      transform: translateX(-50%);
      background-color: rgba(0,0,0,0.8);
      color: #fff;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      transition: opacity 0.3s ease;
      z-index: 10;
      white-space: nowrap;
    }
    .calendario-eventos__mini-dia:hover .calendario-eventos__tooltip {
      visibility: visible;
      opacity: 1;
    }
    .calendario-eventos__mini-dia.hoy {
      outline: 2px solid blue;
    }
    /* =============================
       LISTA DE ANUNCIOS (EVENTOS)
    ============================= */
    .calendario-eventos__lista {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1.5rem;
    }
    .calendario-eventos__item {
      background-color: #fff;
      border: 1px solid #fdfdfd;
      border-radius: 8px;
      padding: 1.5rem;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      position: relative;
    }
    .calendario-eventos__item:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    .calendario-eventos__item-titulo {
      font-size: 1.5rem;
      margin-bottom: 0.75rem;
      color: #ff6f61;
    }
    .calendario-eventos__item-contenido {
      font-size: 1rem;
      margin-bottom: 1rem;
      color: #333;
    }
    .calendario-eventos__item-meta {
      font-size: 0.9rem;
      color: #333;
      display: flex;
      justify-content: space-between;
    }
    .calendario-eventos__item--festivo {
      border-left: 6px solid #FF6F61;
    }
    .calendario-eventos__item--falla {
      border-left: 6px solid #00909E;
    }
    .calendario-eventos__item--evento {
      border-left: 6px solid #4A4A4A;
    }
    .calendario-eventos__item--urgente {
      border-left: 6px solid #C13584;
    }
    .calendario-eventos__item--informacion {
      border-left: 6px solid #FFD700;
      color: #000;
    }
    .calendario-eventos__item--recordatorio {
      border-left: 6px solid #000080;
    }
    /* =============================
       MODO SENCILLO / AVANZADO
    ============================= */
    .modo-sencillo .avanzado {
      display: none;
    }
    /* ===== MODAL ICS ===== */
    .ics-modal.oculto {
      display: none;
    }
    .ics-modal {
      position: fixed;
      z-index: 9999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .ics-modal__contenido {
      background-color: #fff;
      padding: 1.5rem;
      border-radius: 8px;
      width: 300px;
      position: relative;
    }
    .ics-modal__cerrar {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      background: transparent;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
    }
    .ics-modal__input,
    .ics-modal__textarea {
      width: 100%;
      margin-bottom: 1rem;
      padding: 0.5rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    .ics-modal__boton {
      background-color: #ff6f61;
      color: #fff;
      border: none;
      border-radius: 5px;
      padding: 0.6rem 1rem;
      cursor: pointer;
    }
    .ics-modal__boton:hover {
      background-color: #444;
    }
  </style>
</head>
<body>
  <div class="calendario-eventos modo-sencillo" id="calendarioContenedor">
    <!-- Acciones -->
    <div class="calendario-eventos__acciones">
      <button class="calendario-eventos__boton-quitar" id="botonQuitarFiltros">Quitar Filtros (Alt+R)</button>
      <button class="calendario-eventos__modo-boton" id="botonModo">Cambiar a Modo Avanzado</button>
    </div>
    <header class="calendario-eventos__cabecera">
      <h1 class="calendario-eventos__cabecera-titulo">Calendario de Eventos</h1>
    </header>
    <!-- Controles de filtrado -->
    <div class="calendario-eventos__controles">
      <div class="calendario-eventos__fila fila-basica">
        <div class="calendario-eventos__control">
          <label for="filtro-busqueda">Buscar</label>
          <input type="text" id="filtro-busqueda" class="calendario-eventos__control-busqueda" placeholder="Palabras clave">
        </div>
        <div class="calendario-eventos__control">
          <label for="filtro-rango-fecha">Rango de fechas</label>
          <div class="calendario-eventos__control-fecha-wrapper">
            <input type="text" id="filtro-rango-fecha" class="calendario-eventos__control-fecha" placeholder="dd/mm/aaaa a dd/mm/aaaa" required>
            <button id="borrar-rango-fecha" class="calendario-eventos__control-fecha-borrar">✕</button>
          </div>
        </div>
        <div class="calendario-eventos__control">
          <label for="filtro-categoria">Categoría</label>
          <select id="filtro-categoria" class="calendario-eventos__control-texto">
            <option value="">Todas</option>
            <option value="Festivo">Festivo</option>
            <option value="Falla">Falla</option>
            <option value="Evento">Evento</option>
            <option value="Urgente">Urgente</option>
            <option value="Informacion">Informacion</option>
            <option value="Recordatorio">Recordatorio</option>
          </select>
        </div>
      </div>
      <div class="calendario-eventos__fila fila-avanzada avanzado">
        <div class="calendario-eventos__control">
          <label for="filtro-fecha">Fecha puntual</label>
          <div class="calendario-eventos__control-fecha-wrapper">
            <input type="date" id="filtro-fecha" class="calendario-eventos__control-fecha" placeholder="YYYY-MM-DD">
            <button id="borrar-fecha" class="calendario-eventos__control-fecha-borrar">✕</button>
          </div>
        </div>
      </div>
      <div class="calendario-eventos__fila fila-avanzada avanzado">
        <div class="calendario-eventos__control">
          <label for="filtro-dia">Día (2 dígitos)</label>
          <div class="calendario-eventos__campo-wrapper">
            <input type="text" id="filtro-dia" class="calendario-eventos__control-texto" placeholder="DD" maxlength="2" pattern="^\\d{1,2}$" inputmode="numeric" title="Día entre 01 y 31">
            <button class="calendario-eventos__borrar-campo" id="borrar-dia">✕</button>
          </div>
        </div>
        <div class="calendario-eventos__control">
          <label for="filtro-mes">Mes (2 dígitos)</label>
          <div class="calendario-eventos__campo-wrapper">
            <input type="text" id="filtro-mes" class="calendario-eventos__control-texto" placeholder="MM" maxlength="2" pattern="^\\d{1,2}$" inputmode="numeric" title="Mes entre 01 y 12">
            <button class="calendario-eventos__borrar-campo" id="borrar-mes">✕</button>
          </div>
        </div>
        <div class="calendario-eventos__control">
          <label for="filtro-ano">Año (4 dígitos)</label>
          <div class="calendario-eventos__campo-wrapper">
            <input type="text" id="filtro-ano" class="calendario-eventos__control-texto" placeholder="YYYY" maxlength="4" pattern="^\\d{4}$" inputmode="numeric" title="Introduzca 4 dígitos (p.ej. 2025)">
            <button class="calendario-eventos__borrar-campo" id="borrar-ano">✕</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Leyenda -->
    <div class="calendario-eventos__leyenda" id="info-mes"></div>
    <!-- Mini Calendario -->
    <div class="calendario-eventos__mini" id="mini-calendario">
      <!-- Se genera dinámicamente -->
    </div>
    <!-- Descripción de eventos -->
    <div class="calendario-eventos__detalles-mes" id="descripcion-eventos-mes"></div>
    <!-- Lista de anuncios -->
    <div class="calendario-eventos__lista" id="lista-anuncios"></div>
  </div>

  <!-- MODAL ICS (oculto por defecto) -->
  <div id="icsModal" class="ics-modal oculto">
    <div class="ics-modal__contenido">
      <button class="ics-modal__cerrar" id="icsCerrarBtn">×</button>
      <h2 id="icsModalTitulo">Día 18 (Martes)</h2>
      <label for="icsEvento">Evento</label>
      <input type="text" id="icsEvento" class="ics-modal__input" value="Falla">
      <label for="icsHoraInicio">Hora inicial</label>
      <input type="time" id="icsHoraInicio" class="ics-modal__input" value="00:00">
      <label for="icsHoraFin">Hora final</label>
      <input type="time" id="icsHoraFin" class="ics-modal__input" value="23:59">
      <label for="icsNotas">Notas</label>
      <textarea id="icsNotas" class="ics-modal__textarea" placeholder="Introduzca sus notas"></textarea>
      <button id="icsAceptarBtn" class="ics-modal__boton">ACEPTAR</button>
    </div>
  </div>

  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    /********************************************
     * Datos COMPLETOS
     ********************************************/
    const eventos = [
      { id: 1, title: "Año Nuevo", description: "Celebración del Año Nuevo", date: "2025-01-01", category: "Festivo" },
      { id: 2, title: "Epifanía del Señor", description: "Celebración de la Epifanía", date: "2025-01-06", category: "Festivo" },
      { id: 3, title: "San Vicente Mártir", description: "Festividad en honor a San Vicente", date: "2025-01-22", category: "Festivo" },
      { id: 4, title: "San José", description: "Festividad en honor a San José", date: "2025-03-19", category: "Festivo" },
      { id: 5, title: "Viernes Santo", description: "Celebración del Viernes Santo", date: "2025-04-18", category: "Festivo" },
      { id: 6, title: "Lunes de Pascua", description: "Celebración del Lunes de Pascua", date: "2025-04-21", category: "Festivo" },
      { id: 7, title: "San Vicente Ferrer", description: "Festividad en honor a San Vicente Ferrer", date: "2025-04-28", category: "Festivo" },
      { id: 8, title: "Fiesta del Trabajo", description: "Celebración del Día del Trabajo", date: "2025-05-01", category: "Festivo" },
      { id: 9, title: "San Juan", description: "Festividad en honor a San Juan", date: "2025-06-24", category: "Festivo" },
      { id: 10, title: "Asunción de la Virgen", description: "Celebración de la Asunción", date: "2025-08-15", category: "Festivo" },
      { id: 11, title: "Día de la C. Valenciana", description: "Fiesta de la Comunidad Valenciana", date: "2025-10-09", category: "Festivo" },
      { id: 12, title: "Todos los Santos", description: "Festividad de Todos los Santos", date: "2025-11-01", category: "Festivo" },
      { id: 13, title: "Día de la Constitución", description: "Celebración de la Constitución", date: "2025-12-06", category: "Festivo" },
      { id: 14, title: "Inmaculada Concepción", description: "Celebración de la Inmaculada Concepción", date: "2025-12-08", category: "Festivo" },
      { id: 15, title: "Navidad", description: "Celebración de la Navidad", date: "2025-12-25", category: "Festivo" },
      { id: 16, title: "Fallas", description: "Celebración de Fallas", date: "2025-03-15", category: "Falla" },
      { id: 17, title: "Fallas", description: "Celebración de Fallas", date: "2025-03-16", category: "Falla" },
      { id: 18, title: "Fallas", description: "Celebración de Fallas", date: "2025-03-17", category: "Falla" },
      { id: 19, title: "Fallas", description: "Celebración de Fallas", date: "2025-03-18", category: "Falla" },
      { id: 20, title: "San José", description: "Festividad y Fallas", date: "2025-03-19", category: "Falla" },
      { id: 21, title: "San Valentín", description: "Día de San Valentín", date: "2025-02-14", category: "Evento" },
      { id: 22, title: "Día Internacional de la Mujer", description: "Celebración del Día Internacional de la Mujer", date: "2025-03-08", category: "Evento" },
      { id: 23, title: "Aviso Urgente", description: "Aviso urgente para todos", date: "2025-04-05", category: "Urgente" },
      { id: 24, title: "Información Importante", description: "Información relevante sobre el evento", date: "2025-04-07", category: "Informacion" },
      { id: 25, title: "Recordatorio", description: "Recordatorio de evento", date: "2025-04-09", category: "Recordatorio" },
      { id: 26, title: "Año Nuevo", description: "Celebración del Año Nuevo", date: "2026-01-01", category: "Festivo" },
      { id: 27, title: "Epifanía del Señor", description: "Celebración de la Epifanía", date: "2026-01-06", category: "Festivo" },
      { id: 28, title: "San Vicente Mártir", description: "Festividad en honor a San Vicente", date: "2026-01-22", category: "Festivo" },
      { id: 29, title: "San José", description: "Festividad en honor a San José", date: "2026-03-19", category: "Festivo" },
      { id: 30, title: "Viernes Santo", description: "Celebración del Viernes Santo", date: "2026-04-03", category: "Festivo" },
      { id: 31, title: "Lunes de Pascua", description: "Celebración del Lunes de Pascua", date: "2026-04-06", category: "Festivo" },
      { id: 32, title: "San Vicente Ferrer", description: "Festividad en honor a San Vicente Ferrer", date: "2026-04-28", category: "Festivo" },
      { id: 33, title: "Fiesta del Trabajo", description: "Celebración del Día del Trabajo", date: "2026-05-01", category: "Festivo" },
      { id: 34, title: "San Juan", description: "Festividad en honor a San Juan", date: "2026-06-24", category: "Festivo" },
      { id: 35, title: "Asunción de la Virgen", description: "Celebración de la Asunción", date: "2026-08-15", category: "Festivo" },
      { id: 36, title: "Día de la C. Valenciana", description: "Fiesta de la Comunidad Valenciana", date: "2026-10-09", category: "Festivo" },
      { id: 37, title: "Todos los Santos", description: "Festividad de Todos los Santos", date: "2026-11-01", category: "Festivo" },
      { id: 38, title: "Día de la Constitución", description: "Celebración de la Constitución", date: "2026-12-06", category: "Festivo" },
      { id: 39, title: "Inmaculada Concepción", description: "Celebración de la Inmaculada Concepción", date: "2026-12-08", category: "Festivo" },
      { id: 40, title: "Navidad", description: "Celebración de la Navidad", date: "2026-12-25", category: "Festivo" },
      { id: 41, title: "Fallas", description: "Celebración de Fallas", date: "2026-03-15", category: "Falla" },
      { id: 42, title: "Fallas", description: "Celebración de Fallas", date: "2026-03-16", category: "Falla" },
      { id: 43, title: "Fallas", description: "Celebración de Fallas", date: "2026-03-17", category: "Falla" },
      { id: 44, title: "Fallas", description: "Celebración de Fallas", date: "2026-03-18", category: "Falla" },
      { id: 45, title: "San José", description: "Festividad y Fallas", date: "2026-03-19", category: "Falla" },
      { id: 46, title: "San Valentín", description: "Día de San Valentín", date: "2026-02-14", category: "Evento" },
      { id: 47, title: "Día Internacional de la Mujer", description: "Celebración del Día Internacional de la Mujer", date: "2026-03-08", category: "Evento" }
    ];
    
    const MESES = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
    
    /********************************************
     * Configurar Flatpickr para el rango (d/m/Y y " a ")
     ********************************************/
    flatpickr("#filtro-rango-fecha", {
      mode: "range",
      dateFormat: "d/m/Y",
      rangeSeparator: " a ",
      locale: {
        firstDayOfWeek: 1,
        weekdays: {
          shorthand: ["Lun","Mar","Mié","Jue","Vie","Sáb","Dom"],
          longhand: ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"]
        },
        months: {
          shorthand: ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"],
          longhand: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"]
        }
      },
      onChange: function(selectedDates, dateStr, instance) {
        actualizarVista();
      }
    });
    
    /********************************************
     * Funciones para convertir fechas
     ********************************************/
    function toDateObj(str) {
      if (!str || !/^\d{4}-\d{2}-\d{2}$/.test(str)) return null;
      const [yyyy, mm, dd] = str.split("-").map(Number);
      return new Date(yyyy, mm - 1, dd);
    }
    function toDateDMY(str) {
      const regex = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/;
      const match = str.match(regex);
      if (!match) return null;
      const [_, dd, mm, yyyy] = match;
      return new Date(+yyyy, +mm - 1, +dd);
    }
    
    /********************************************
     * Función: cumpleRango
     ********************************************/
    function cumpleRango(eDateStr, iniDate, finDate) {
      const eDate = toDateObj(eDateStr);
      if (!eDate) return false;
      if (iniDate && eDate < iniDate) return false;
      if (finDate && eDate > finDate) return false;
      return true;
    }
    
    /********************************************
     * Integración dinámica con filtros y eventos
     ********************************************/
    function actualizarFiltrosConCelda(celda, dia, mes, anio) {
      const diaStr = String(dia).padStart(2, "0");
      const mesStr = String(mes + 1).padStart(2, "0");
      document.getElementById('filtro-dia').value = diaStr;
      document.getElementById('filtro-mes').value = mesStr;
      document.getElementById('filtro-ano').value = String(anio);
      actualizarVista();
    }
    function resaltarCeldaSeleccionada(celda) {
      const celdas = document.querySelectorAll('.calendario-eventos__mini-dia');
      celdas.forEach(el => el.classList.remove('seleccionado'));
      celda.classList.add('seleccionado');
      setTimeout(() => {
        celda.classList.remove('seleccionado');
      }, 500);
    }
    
    /********************************************
     * Optimización de la generación del mini calendario
     ********************************************/
    function calcularOffset(mes, anio) {
      const primerDia = new Date(anio, mes, 1).getDay();
      return (primerDia === 0) ? 6 : primerDia - 1;
    }
    function crearCeldaDia(d, mes, anio, eventosDelDia) {
      const celda = document.createElement('div');
      celda.className = 'calendario-eventos__mini-dia';
      celda.textContent = d;
      if (eventosDelDia.length > 1) {
        const badge = document.createElement('span');
        badge.className = 'badge';
        badge.textContent = eventosDelDia.length;
        celda.appendChild(badge);
      }
      if (eventosDelDia.length > 0) {
        const tooltip = document.createElement('div');
        tooltip.className = 'calendario-eventos__tooltip';
        tooltip.textContent = eventosDelDia.map(e => e.title).join(", ");
        celda.appendChild(tooltip);
      }
      celda.addEventListener('click', () => {
        actualizarFiltrosConCelda(celda, d, mes, anio);
        resaltarCeldaSeleccionada(celda);
      });
      return celda;
    }
    function construirCuadricula(mes, anio, eventosFiltrados) {
      const fragment = document.createDocumentFragment();
      const diasSemana = ["L", "M", "X", "J", "V", "S", "D"];
      diasSemana.forEach(dia => {
        const celda = document.createElement('div');
        celda.className = 'calendario-eventos__mini-encabezado';
        celda.textContent = dia;
        fragment.appendChild(celda);
      });
      const offset = calcularOffset(mes, anio);
      for (let i = 0; i < offset; i++) {
        const vacio = document.createElement('div');
        vacio.className = 'calendario-eventos__mini-dia';
        fragment.appendChild(vacio);
      }
      const numDias = new Date(anio, mes + 1, 0).getDate();
      for (let d = 1; d <= numDias; d++) {
        const fechaCelda = `${anio}-${String(mes + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
        const eventosDelDia = eventosFiltrados.filter(ev => ev.date === fechaCelda);
        const celdaDia = crearCeldaDia(d, mes, anio, eventosDelDia);
        const hoy = new Date();
        if (anio === hoy.getFullYear() && mes === hoy.getMonth() && d === hoy.getDate()) {
          celdaDia.classList.add('hoy');
        }
        fragment.appendChild(celdaDia);
      }
      return fragment;
    }
    function generarMiniCalendario(mes, anio, eventosFiltrados) {
      const contenedor = document.getElementById('mini-calendario');
      contenedor.style.opacity = 0;
      setTimeout(() => {
        const fragment = construirCuadricula(mes, anio, eventosFiltrados);
        contenedor.innerHTML = "";
        contenedor.appendChild(fragment);
        contenedor.style.opacity = 1;
      }, 100);
    }
    
    /********************************************
     * Filtrar eventos
     ********************************************/
    function filtrarEventos() {
      const busqueda     = document.getElementById('filtro-busqueda').value.trim().toLowerCase();
      const categoria    = document.getElementById('filtro-categoria').value.trim();
      const fechaPuntual = document.getElementById('filtro-fecha').value.trim();
      const diaFiltro    = document.getElementById('filtro-dia').value.trim();
      const mesFiltro    = document.getElementById('filtro-mes').value.trim();
      const anoFiltro    = document.getElementById('filtro-ano').value.trim();
      const rangoStr     = document.getElementById('filtro-rango-fecha').value.trim();

      if (!busqueda && !categoria && !fechaPuntual && !diaFiltro && !mesFiltro && !anoFiltro && !rangoStr) {
        return [];
      }
      let fechaInicio = null;
      let fechaFin = null;
      const fp = document.getElementById('filtro-rango-fecha')._flatpickr;
      if (fp && fp.selectedDates.length === 2) {
        fechaInicio = fp.selectedDates[0];
        fechaFin = fp.selectedDates[1];
      }
      return eventos.filter(e => {
        let coincide = true;
        if (busqueda) {
          const titulo = e.title.toLowerCase();
          const desc   = e.description.toLowerCase();
          if (!titulo.includes(busqueda) && !desc.includes(busqueda)) {
            coincide = false;
          }
        }
        if (coincide && anoFiltro) {
          if (!e.date.startsWith(anoFiltro)) {
            coincide = false;
          }
        }
        if (coincide && diaFiltro) {
          const diaEvento = e.date.substring(8, 10);
          if (diaEvento !== diaFiltro.padStart(2, "0")) {
            coincide = false;
          }
        }
        if (coincide && categoria) {
          if (e.category !== categoria) {
            coincide = false;
          }
        }
        if (coincide && fechaPuntual) {
          if (e.date !== fechaPuntual) {
            coincide = false;
          }
        }
        if (coincide && mesFiltro) {
          const mesEvento = e.date.substring(5, 7);
          if (mesEvento !== mesFiltro.padStart(2, "0")) {
            coincide = false;
          }
        }
        if (coincide && fechaInicio && fechaFin) {
          if (!cumpleRango(e.date, fechaInicio, fechaFin)) {
            coincide = false;
          }
        }
        return coincide;
      });
    }
    
    function actualizarLeyenda(mes, anio) {
      const infoMes = document.getElementById('info-mes');
      infoMes.textContent = `Mostrando eventos de ${MESES[mes]} ${anio}`;
    }
    
    function mostrarDescripcionMes(eventosDelMes, mes, anio) {
      const contenedor = document.getElementById('descripcion-eventos-mes');
      contenedor.innerHTML = '';
      const nombreMes = MESES[mes];
      const titulo = document.createElement('h2');
      titulo.textContent = `Eventos de ${nombreMes} ${anio}`;
      contenedor.appendChild(titulo);
      if (eventosDelMes.length === 0) {
        const p = document.createElement('p');
        p.textContent = 'No hay eventos para este mes.';
        contenedor.appendChild(p);
        return;
      }
      const ul = document.createElement('ul');
      eventosDelMes.forEach(ev => {
        const li = document.createElement('li');
        li.textContent = `${ev.title} (${ev.date}): ${ev.description}`;
        ul.appendChild(li);
      });
      contenedor.appendChild(ul);
    }
    
    /********************************************
     * Función: obtenerNombreDia
     ********************************************/
    function obtenerNombreDia(dateObj) {
      const dias = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
      return dias[dateObj.getDay()];
    }
    
    /********************************************
     * Renderizar lista de eventos (con modal ICS al hacer click en la tarjeta)
     ********************************************/
    function renderizarLista(eventosFiltrados) {
      const lista = document.getElementById('lista-anuncios');
      lista.innerHTML = '';
      if (eventosFiltrados.length === 0) {
        lista.innerHTML = `
          <p>No se han encontrado eventos que coincidan con los filtros seleccionados.</p>
          <button id="btn-reset-filtros">Borrar filtros</button>
        `;
        document.getElementById('btn-reset-filtros').addEventListener('click', () => {
          resetearFiltros();
        });
        return;
      }
      eventosFiltrados.forEach(e => {
        let claseModificador = '';
        if (e.category === 'Festivo') {
          claseModificador = 'calendario-eventos__item--festivo';
        } else if (e.category === 'Falla') {
          claseModificador = 'calendario-eventos__item--falla';
        } else if (e.category === 'Evento') {
          claseModificador = 'calendario-eventos__item--evento';
        } else if (e.category === 'Urgente') {
          claseModificador = 'calendario-eventos__item--urgente';
        } else if (e.category === 'Informacion') {
          claseModificador = 'calendario-eventos__item--informacion';
        } else if (e.category === 'Recordatorio') {
          claseModificador = 'calendario-eventos__item--recordatorio';
        }
        const div = document.createElement('div');
        div.className = `calendario-eventos__item ${claseModificador}`;
        div.innerHTML = `
          <h2 class="calendario-eventos__item-titulo">${e.title}</h2>
          <p class="calendario-eventos__item-contenido">${e.description}</p>
          <div class="calendario-eventos__item-meta">
            <span>${e.date}</span>
            <span>${e.category}</span>
          </div>
        `;
        // Al hacer clic en la tarjeta se abre el modal ICS
        div.addEventListener('click', () => {
          const [year, m, d] = e.date.split('-').map(Number);
          const dateObj = new Date(year, m - 1, d);
          const dayName = obtenerNombreDia(dateObj);
          abrirICSModal({
            date: d,
            dayName,
            eventTitle: e.title,
            startTime: "00:00",
            endTime: "23:59",
            notes: e.description
          });
        });
        lista.appendChild(div);
      });
    }
    
    function actualizarVista() {
      const filtrados = filtrarEventos();
      renderizarLista(filtrados);
      let mes = new Date().getMonth();
      let anio = new Date().getFullYear();
      const mesFiltro = document.getElementById('filtro-mes').value.trim();
      const anoFiltro = document.getElementById('filtro-ano').value.trim();
      if (mesFiltro) mes = parseInt(mesFiltro) - 1;
      if (anoFiltro) anio = parseInt(anoFiltro);
      actualizarLeyenda(mes, anio);
      const eventosEsteMes = filtrados.filter(e => {
        const yearE = parseInt(e.date.substring(0, 4));
        const monthE = parseInt(e.date.substring(5, 7));
        return (yearE === anio && monthE === (mes + 1));
      });
      mostrarDescripcionMes(eventosEsteMes, mes, anio);
      generarMiniCalendario(mes, anio, filtrados);
    }
    
    function resetearFiltros() {
      document.getElementById('filtro-busqueda').value = '';
      document.getElementById('filtro-categoria').value = '';
      if (document.getElementById('filtro-rango-fecha')._flatpickr) {
        document.getElementById('filtro-rango-fecha')._flatpickr.clear();
      }
      document.getElementById('filtro-fecha').value = '';
      document.getElementById('filtro-dia').value = '';
      document.getElementById('filtro-mes').value = '';
      document.getElementById('filtro-ano').value = '';
      actualizarVista();
    }
    
    function toggleModo() {
      const contenedor = document.getElementById('calendarioContenedor');
      const boton = document.getElementById('botonModo');
      if (contenedor.classList.contains('modo-sencillo')) {
        contenedor.classList.remove('modo-sencillo');
        contenedor.classList.add('modo-avanzado');
        boton.textContent = "Cambiar a Modo Sencillo";
      } else {
        contenedor.classList.remove('modo-avanzado');
        contenedor.classList.add('modo-sencillo');
        boton.textContent = "Cambiar a Modo Avanzado";
      }
    }
    
    function manejarAtajos(e) {
      if (e.altKey && e.key.toLowerCase() === 'r') {
        resetearFiltros();
      }
    }
    
    function asignarEventos() {
      const controles = document.querySelectorAll(
        '#filtro-busqueda, #filtro-categoria, #filtro-fecha, #filtro-dia, #filtro-mes, #filtro-ano'
      );
      controles.forEach(ctrl => {
        ctrl.addEventListener('change', actualizarVista);
        ctrl.addEventListener('input', actualizarVista);
      });
      document.getElementById('borrar-rango-fecha').addEventListener('click', () => {
        if (document.getElementById('filtro-rango-fecha')._flatpickr) {
          document.getElementById('filtro-rango-fecha')._flatpickr.clear();
        }
        actualizarVista();
      });
      document.getElementById('borrar-fecha').addEventListener('click', () => {
        document.getElementById('filtro-fecha').value = '';
        actualizarVista();
      });
      document.getElementById('borrar-dia').addEventListener('click', () => {
        document.getElementById('filtro-dia').value = '';
        actualizarVista();
      });
      document.getElementById('borrar-mes').addEventListener('click', () => {
        document.getElementById('filtro-mes').value = '';
        actualizarVista();
      });
      document.getElementById('borrar-ano').addEventListener('click', () => {
        document.getElementById('filtro-ano').value = '';
        actualizarVista();
      });
      document.getElementById('botonQuitarFiltros').addEventListener('click', resetearFiltros);
      document.getElementById('botonModo').addEventListener('click', toggleModo);
      document.addEventListener('keydown', manejarAtajos);
    }
    
    /********************************************
     * MODAL ICS: Variables y funciones
     ********************************************/
    const icsModal = document.getElementById('icsModal');
    const icsCerrarBtn = document.getElementById('icsCerrarBtn');
    const icsAceptarBtn = document.getElementById('icsAceptarBtn');
    
    const icsModalTitulo = document.getElementById('icsModalTitulo');
    const icsEventoInput = document.getElementById('icsEvento');
    const icsHoraInicio = document.getElementById('icsHoraInicio');
    const icsHoraFin = document.getElementById('icsHoraFin');
    const icsNotas = document.getElementById('icsNotas');
    
    function abrirICSModal({ date, dayName, eventTitle, startTime, endTime, notes }) {
      icsModalTitulo.textContent = `Día ${date} (${dayName})`;
      icsEventoInput.value = eventTitle || "";
      icsHoraInicio.value = startTime || "00:00";
      icsHoraFin.value = endTime || "23:59";
      icsNotas.value = notes || "";
      icsModal.classList.remove('oculto');
    }
    function cerrarICSModal() {
      icsModal.classList.add('oculto');
    }
    icsCerrarBtn.addEventListener('click', cerrarICSModal);
    icsAceptarBtn.addEventListener('click', () => {
      const titulo = icsModalTitulo.textContent;
      const [ , rawDay ] = titulo.split(" ");
      const eventTitle = icsEventoInput.value;
      const startTime = icsHoraInicio.value;
      const endTime = icsHoraFin.value;
      const notes = icsNotas.value;
      const icsData = generarICS({
        dayLabel: rawDay,
        eventTitle,
        startTime,
        endTime,
        notes
      });
      const blob = new Blob([icsData], { type: 'text/calendar' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'evento.ics';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      cerrarICSModal();
    });
    function generarICS({ dayLabel, eventTitle, startTime, endTime, notes }) {
      // Para este ejemplo se usa una fecha fija; en producción, utilizar la fecha real del evento.
      const fakeDate = new Date(2025, 2, 18);
      const dtStamp = formatearFechaICS(new Date());
      const dtStart = formatearFechaICS(combinarFechaHora(fakeDate, startTime));
      const dtEnd   = formatearFechaICS(combinarFechaHora(fakeDate, endTime));
      return `
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Falla Suïssa
BEGIN:VEVENT
UID:${Date.now()}-falla-suissa
DTSTAMP:${dtStamp}
DTSTART:${dtStart}
DTEND:${dtEnd}
SUMMARY:${limpiarICS(eventTitle)}
DESCRIPTION:${limpiarICS(notes)}
END:VEVENT
END:VCALENDAR
      `.trim();
    }
    function formatearFechaICS(dateObj) {
      const year = dateObj.getFullYear();
      const month = String(dateObj.getMonth() + 1).padStart(2, '0');
      const day = String(dateObj.getDate()).padStart(2, '0');
      const hours = String(dateObj.getHours()).padStart(2, '0');
      const minutes = String(dateObj.getMinutes()).padStart(2, '0');
      const seconds = String(dateObj.getSeconds()).padStart(2, '0');
      return `${year}${month}${day}T${hours}${minutes}${seconds}`;
    }
    function combinarFechaHora(dateObj, hhmm) {
      const [hh, mm] = hhmm.split(':').map(Number);
      const newDate = new Date(dateObj);
      newDate.setHours(hh || 0, mm || 0, 0, 0);
      return newDate;
    }
    function limpiarICS(str) {
      return (str || "")
        .replace(/(\r\n|\r|\n)/g, "\\n")
        .replace(/,/g, "\\,");
    }
    
    /********************************************
     * Función: iniciar
     ********************************************/
    function iniciar() {
      asignarEventos();
      actualizarVista();
    }
    document.addEventListener('DOMContentLoaded', iniciar);
  </script>
</body>
</html>
